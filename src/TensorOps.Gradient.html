<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds           #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts    #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE GADTs               #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE LambdaCase          #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE PolyKinds           #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE RankNTypes          #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE TypeApplications    #-}</span><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE TypeOperators       #-}</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">TensorOps</span><span class="hs-operator">.</span><span class="hs-identifier">Gradient</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-12"></a><span>
</span><a name="line-13"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Foldable</span><span>
</span><a name="line-14"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Singletons</span><span>
</span><a name="line-15"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Singletons</span><span class="hs-operator">.</span><span class="hs-identifier">Prelude</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Sing</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-16"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Combinator</span><span>
</span><a name="line-17"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Conjunction</span><span>
</span><a name="line-18"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Index</span><span>
</span><a name="line-19"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Length</span><span>
</span><a name="line-20"></a><span class="hs-keyword">import</span><span>           </span><a href="Data.Type.Length.Util.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Length</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span></a><span>        </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TCL</span><span>
</span><a name="line-21"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Product</span><span>
</span><a name="line-22"></a><span class="hs-keyword">import</span><span>           </span><a href="Data.Type.Product.Util.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Product</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span>           </span><a href="Data.Type.Sing.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Sing</span></a><span>
</span><a name="line-24"></a><span class="hs-keyword">import</span><span>           </span><a href="Data.Type.Uniform.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Uniform</span></a><span>
</span><a name="line-25"></a><span class="hs-keyword">import</span><span>           </span><a href="TensorOps.Run.html"><span class="hs-identifier">TensorOps</span><span class="hs-operator">.</span><span class="hs-identifier">Run</span></a><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span>           </span><a href="TensorOps.Types.html"><span class="hs-identifier">TensorOps</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>
</span><a name="line-27"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span class="hs-operator">.</span><span class="hs-identifier">Higher</span><span>
</span><a name="line-28"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span class="hs-operator">.</span><span class="hs-identifier">Witness</span><span>
</span><a name="line-29"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Family</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span>
</span><a name="line-30"></a><span class="hs-keyword">import</span><span>           </span><a href="Type.Family.List.Util.html"><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Family</span><span class="hs-operator">.</span><span class="hs-identifier">List</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span></a><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="TensorOps.Tensor.html"><span class="hs-identifier">TensorOps</span><span class="hs-operator">.</span><span class="hs-identifier">Tensor</span></a><span>             </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TT</span><span>
</span><a name="line-32"></a><span>
</span><a name="line-33"></a><span class="hs-identifier">gradTOp</span><span>
</span><a name="line-34"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-1627820573"><a href="#local-1627820573"><span class="hs-identifier">ns</span></a></a><span> </span><a name="local-1627820574"><a href="#local-1627820574"><span class="hs-identifier">ms</span></a></a><span> </span><a name="local-1627820575"><a href="#local-1627820575"><span class="hs-identifier">t</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><a href="TensorOps.Types.html#Tensor"><span class="hs-identifier hs-type">Tensor</span></a><span> </span><a href="#local-1627820575"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Floating</span><span> </span><span class="hs-special">(</span><a href="TensorOps.Types.html#ElemT"><span class="hs-identifier hs-type">ElemT</span></a><span> </span><a href="#local-1627820575"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Sing</span><span> </span><a href="#local-1627820573"><span class="hs-identifier hs-type">ns</span></a><span>
</span><a name="line-36"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Sing</span><span> </span><a href="#local-1627820574"><span class="hs-identifier hs-type">ms</span></a><span>
</span><a name="line-37"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><a href="TensorOps.Types.html#TOp"><span class="hs-identifier hs-type">TOp</span></a><span> </span><a href="#local-1627820573"><span class="hs-identifier hs-type">ns</span></a><span> </span><a href="#local-1627820574"><span class="hs-identifier hs-type">ms</span></a><span>
</span><a name="line-38"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Prod</span><span> </span><a href="#local-1627820575"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-1627820573"><span class="hs-identifier hs-type">ns</span></a><span>    </span><span class="hs-comment">-- ^ inputs</span><span>
</span><a name="line-39"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Prod</span><span> </span><a href="#local-1627820575"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-1627820574"><span class="hs-identifier hs-type">ms</span></a><span>    </span><span class="hs-comment">-- ^ d target / d outputs</span><span>
</span><a name="line-40"></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Prod</span><span> </span><a href="#local-1627820575"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-1627820573"><span class="hs-identifier hs-type">ns</span></a><span>    </span><span class="hs-comment">-- ^ d target / d inputs</span><span>
</span><a name="line-41"></a><a name="gradTOp"><a href="TensorOps.Gradient.html#gradTOp"><span class="hs-identifier">gradTOp</span></a></a><span> </span><a name="local-1627820576"><a href="#local-1627820576"><span class="hs-identifier">sNs</span></a></a><span> </span><a name="local-1627820577"><a href="#local-1627820577"><span class="hs-identifier">sMs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">\\</span><span> </span><a href="Data.Type.Sing.html#witSings"><span class="hs-identifier hs-var">witSings</span></a><span> </span><a href="#local-1627820576"><span class="hs-identifier hs-var">sNs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span>
</span><a name="line-42"></a><span>                  </span><span class="hs-special">(</span><span class="hs-operator hs-var">\\</span><span> </span><a href="Data.Type.Sing.html#witSings"><span class="hs-identifier hs-var">witSings</span></a><span> </span><a href="#local-1627820577"><span class="hs-identifier hs-var">sMs</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-glyph">\</span><span class="hs-keyword">case</span><span>
</span><a name="line-43"></a><span>    </span><a href="TensorOps.Types.html#Lift"><span class="hs-identifier hs-var">Lift</span></a><span> </span><a name="local-1627820578"><a href="#local-1627820578"><span class="hs-identifier">uN</span></a></a><span> </span><a name="local-1627820579"><a href="#local-1627820579"><span class="hs-identifier">uM</span></a></a><span> </span><a name="local-1627820580"><a href="#local-1627820580"><span class="hs-identifier">f</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1627820578"><span class="hs-identifier hs-var">uN</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-44"></a><span>      </span><a href="Data.Type.Uniform.html#U%D8"><span class="hs-identifier hs-var">U&#216;</span></a><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">&#216;</span><span>
</span><a name="line-45"></a><span>      </span><a href="Data.Type.Uniform.html#US"><span class="hs-identifier hs-var">US</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-glyph">\</span><a name="local-1627820581"><a href="#local-1627820581"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Data.Type.Product.Util.html#vecToProd"><span class="hs-identifier hs-var">vecToProd</span></a><span> </span><span class="hs-identifier">getI</span><span> </span><a href="#local-1627820578"><span class="hs-identifier hs-var">uN</span></a><span>
</span><a name="line-46"></a><span>                  </span><span class="hs-operator hs-var">.</span><span> </span><a href="TensorOps.Tensor.html#gradLift"><span class="hs-identifier hs-var">TT</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">gradLift</span></a><span> </span><a href="#local-1627820580"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><a href="Data.Type.Product.Util.html#prodToVec"><span class="hs-identifier hs-var">prodToVec</span></a><span> </span><span class="hs-identifier hs-var">I</span><span> </span><a href="#local-1627820578"><span class="hs-identifier hs-var">uN</span></a><span> </span><a href="#local-1627820581"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span>                  </span><span class="hs-operator hs-var">.</span><span> </span><a href="Data.Type.Product.Util.html#prodToVec"><span class="hs-identifier hs-var">prodToVec</span></a><span> </span><span class="hs-identifier hs-var">I</span><span> </span><a href="#local-1627820579"><span class="hs-identifier hs-var">uM</span></a><span>
</span><a name="line-48"></a><span>    </span><a href="TensorOps.Types.html#GMul"><span class="hs-identifier hs-var">GMul</span></a><span> </span><a name="local-1627820582"><a href="#local-1627820582"><span class="hs-identifier">lM</span></a></a><span> </span><a name="local-1627820583"><a href="#local-1627820583"><span class="hs-identifier">lO</span></a></a><span> </span><a name="local-1627820584"><a href="#local-1627820584"><span class="hs-identifier">lN</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-glyph">\</span><span class="hs-keyword">case</span><span>
</span><a name="line-49"></a><span>      </span><span class="hs-comment">-- lM   :: Length m</span><span>
</span><a name="line-50"></a><span>      </span><span class="hs-comment">-- lO   :: Length o</span><span>
</span><a name="line-51"></a><span>      </span><span class="hs-comment">-- lN   :: Length n</span><span>
</span><a name="line-52"></a><span>      </span><span class="hs-comment">-- x    :: t (Head ns)</span><span>
</span><a name="line-53"></a><span>      </span><span class="hs-comment">--      :: t (m ++ o)</span><span>
</span><a name="line-54"></a><span>      </span><span class="hs-comment">-- y    :: t (Head (Tail ns))</span><span>
</span><a name="line-55"></a><span>      </span><span class="hs-comment">--      :: t (Reverse o ++ n)</span><span>
</span><a name="line-56"></a><span>      </span><span class="hs-comment">-- dtdz :: t (Head ms)</span><span>
</span><a name="line-57"></a><span>      </span><span class="hs-comment">--      :: t (m ++ n)</span><span>
</span><a name="line-58"></a><span>      </span><a name="local-1627820585"><a href="#local-1627820585"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-operator hs-var">:&lt;</span><span> </span><a name="local-1627820586"><a href="#local-1627820586"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-operator hs-var">:&lt;</span><span> </span><span class="hs-identifier hs-var">&#216;</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-glyph">\</span><span class="hs-keyword">case</span><span>
</span><a name="line-59"></a><span>        </span><a name="local-1627820587"><a href="#local-1627820587"><span class="hs-identifier">dtdz</span></a></a><span> </span><span class="hs-operator hs-var">:&lt;</span><span> </span><span class="hs-identifier hs-var">&#216;</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">let</span><span> </span><a name="local-1627820588"><a href="#local-1627820588"><span class="hs-identifier">rlO</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Type.Length.Util.html#reverse%27"><span class="hs-identifier hs-var">TCL</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">reverse'</span></a><span> </span><a href="#local-1627820583"><span class="hs-identifier hs-var">lO</span></a><span>
</span><a name="line-60"></a><span>                         </span><span class="hs-identifier">entailCatRev</span><span>
</span><a name="line-61"></a><span>                                </span><span class="hs-glyph">::</span><span> </span><a href="#local-1627820590"><span class="hs-identifier hs-type">p</span></a><span> </span><a href="#local-1627820591"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-62"></a><span>                                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627820590"><span class="hs-identifier hs-type">p</span></a><span> </span><a href="#local-1627820592"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-63"></a><span>                                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SingI</span><span> </span><span class="hs-special">(</span><a href="#local-1627820591"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-operator">++</span><span> </span><a href="#local-1627820592"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator">:-</span><span> </span><span class="hs-identifier hs-type">SingI</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Reverse</span><span> </span><span class="hs-special">(</span><a href="#local-1627820591"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-operator">++</span><span> </span><a href="#local-1627820592"><span class="hs-identifier hs-type">b</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-64"></a><span>                         </span><a name="local-1627820589"><a href="#local-1627820589"><span class="hs-identifier">entailCatRev</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Type.Sing.html#entailSing"><span class="hs-identifier hs-var">entailSing</span></a><span> </span><a href="Data.Type.Sing.html#sReverse"><span class="hs-identifier hs-var">sReverse</span></a><span>
</span><a name="line-65"></a><span>      </span><span class="hs-comment">-- gmul :: Length m</span><span>
</span><a name="line-66"></a><span>      </span><span class="hs-comment">--      -&gt; Length n</span><span>
</span><a name="line-67"></a><span>      </span><span class="hs-comment">--      -&gt; Length o</span><span>
</span><a name="line-68"></a><span>      </span><span class="hs-comment">--      -&gt; t (m ++ n)</span><span>
</span><a name="line-69"></a><span>      </span><span class="hs-comment">--      -&gt; t (Reverse n ++ o)</span><span>
</span><a name="line-70"></a><span>      </span><span class="hs-comment">--      -&gt; t (m ++ o)</span><span>
</span><a name="line-71"></a><span>      </span><span class="hs-comment">-- transp y :: t (Reverse (Reverse o ++ n))</span><span>
</span><a name="line-72"></a><span>      </span><span class="hs-comment">--          :: t (Reverse n ++ Reverse (Reverse o))</span><span>
</span><a name="line-73"></a><span>      </span><span class="hs-comment">--          :: t (Reverse n ++ o)</span><span>
</span><a name="line-74"></a><span>      </span><span class="hs-comment">-- therefore we need:</span><span>
</span><a name="line-75"></a><span>      </span><span class="hs-comment">--   Reverse (Reverse o ++ n)  :~: Reverse n ++ Reverse (Reverse o)</span><span>
</span><a name="line-76"></a><span>      </span><span class="hs-comment">--   Reverse (Reverse o)       :~: o</span><span>
</span><a name="line-77"></a><span>                     </span><span class="hs-keyword">in</span><span>  </span><span class="hs-special">(</span><a href="TensorOps.Types.html#gmul"><span class="hs-identifier hs-var">gmul</span></a><span> </span><a href="#local-1627820582"><span class="hs-identifier hs-var">lM</span></a><span> </span><a href="#local-1627820584"><span class="hs-identifier hs-var">lN</span></a><span> </span><a href="#local-1627820583"><span class="hs-identifier hs-var">lO</span></a><span> </span><a href="#local-1627820587"><span class="hs-identifier hs-var">dtdz</span></a><span> </span><span class="hs-special">(</span><a href="TensorOps.Types.html#transp"><span class="hs-identifier hs-var">transp</span></a><span> </span><a href="#local-1627820586"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">)</span><span>
</span><a name="line-78"></a><span>                           </span><span class="hs-operator hs-var">\\</span><span> </span><a href="Type.Family.List.Util.html#reverseConcat"><span class="hs-identifier hs-var">reverseConcat</span></a><span> </span><a href="#local-1627820588"><span class="hs-identifier hs-var">rlO</span></a><span> </span><a href="#local-1627820584"><span class="hs-identifier hs-var">lN</span></a><span>
</span><a name="line-79"></a><span>                           </span><span class="hs-operator hs-var">\\</span><span> </span><a href="Type.Family.List.Util.html#reverseReverse"><span class="hs-identifier hs-var">reverseReverse</span></a><span> </span><a href="#local-1627820583"><span class="hs-identifier hs-var">lO</span></a><span>
</span><a name="line-80"></a><span>                           </span><span class="hs-operator hs-var">\\</span><span> </span><a href="#local-1627820589"><span class="hs-identifier hs-var">entailCatRev</span></a><span> </span><a href="#local-1627820588"><span class="hs-identifier hs-var">rlO</span></a><span> </span><a href="#local-1627820584"><span class="hs-identifier hs-var">lN</span></a><span>
</span><a name="line-81"></a><span>                         </span><span class="hs-special">)</span><span>
</span><a name="line-82"></a><span>      </span><span class="hs-comment">-- gmul :: Length (Reverse o)</span><span>
</span><a name="line-83"></a><span>      </span><span class="hs-comment">--      -&gt; Length (Reverse m)</span><span>
</span><a name="line-84"></a><span>      </span><span class="hs-comment">--      -&gt; Length n</span><span>
</span><a name="line-85"></a><span>      </span><span class="hs-comment">--      -&gt; t (Reverse o ++ Reverse m)</span><span>
</span><a name="line-86"></a><span>      </span><span class="hs-comment">--      -&gt; t (Reverse (Reverse m) ++ n)</span><span>
</span><a name="line-87"></a><span>      </span><span class="hs-comment">--      -&gt; t (Reverse o ++ n)</span><span>
</span><a name="line-88"></a><span>      </span><span class="hs-comment">-- transp x :: t (Reverse (m ++ o))</span><span>
</span><a name="line-89"></a><span>      </span><span class="hs-comment">--          :: t (Reverse o ++ Reverse m)</span><span>
</span><a name="line-90"></a><span>      </span><span class="hs-comment">-- dtdz     :: t (m ++ o)</span><span>
</span><a name="line-91"></a><span>      </span><span class="hs-comment">--          :: t (Reverse (Reverse m) ++ o)</span><span>
</span><a name="line-92"></a><span>      </span><span class="hs-comment">-- therefore we need:</span><span>
</span><a name="line-93"></a><span>      </span><span class="hs-comment">--   Reverse (m ++ o)    :~: Reverse o ++ Reverse m</span><span>
</span><a name="line-94"></a><span>      </span><span class="hs-comment">--   Reverse (Reverse m) :~: m</span><span>
</span><a name="line-95"></a><span>                      </span><span class="hs-operator hs-var">:&lt;</span><span> </span><span class="hs-special">(</span><a href="TensorOps.Types.html#gmul"><span class="hs-identifier hs-var">gmul</span></a><span> </span><a href="#local-1627820588"><span class="hs-identifier hs-var">rlO</span></a><span> </span><span class="hs-special">(</span><a href="Data.Type.Length.Util.html#reverse%27"><span class="hs-identifier hs-var">TCL</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">reverse'</span></a><span> </span><a href="#local-1627820582"><span class="hs-identifier hs-var">lM</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627820584"><span class="hs-identifier hs-var">lN</span></a><span>
</span><a name="line-96"></a><span>                               </span><span class="hs-special">(</span><a href="TensorOps.Types.html#transp"><span class="hs-identifier hs-var">transp</span></a><span> </span><a href="#local-1627820585"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-97"></a><span>                               </span><a href="#local-1627820587"><span class="hs-identifier hs-var">dtdz</span></a><span>
</span><a name="line-98"></a><span>                            </span><span class="hs-operator hs-var">\\</span><span> </span><a href="Type.Family.List.Util.html#reverseConcat"><span class="hs-identifier hs-var">reverseConcat</span></a><span> </span><a href="#local-1627820582"><span class="hs-identifier hs-var">lM</span></a><span> </span><a href="#local-1627820583"><span class="hs-identifier hs-var">lO</span></a><span>
</span><a name="line-99"></a><span>                            </span><span class="hs-operator hs-var">\\</span><span> </span><a href="Type.Family.List.Util.html#reverseReverse"><span class="hs-identifier hs-var">reverseReverse</span></a><span> </span><a href="#local-1627820582"><span class="hs-identifier hs-var">lM</span></a><span>
</span><a name="line-100"></a><span>                            </span><span class="hs-operator hs-var">\\</span><span> </span><a href="#local-1627820589"><span class="hs-identifier hs-var">entailCatRev</span></a><span> </span><a href="#local-1627820582"><span class="hs-identifier hs-var">lM</span></a><span> </span><a href="#local-1627820583"><span class="hs-identifier hs-var">lO</span></a><span>
</span><a name="line-101"></a><span>                         </span><span class="hs-special">)</span><span>
</span><a name="line-102"></a><span>                      </span><span class="hs-operator hs-var">:&lt;</span><span> </span><span class="hs-identifier hs-var">&#216;</span><span>
</span><a name="line-103"></a><span>    </span><a href="TensorOps.Types.html#Transp"><span class="hs-identifier hs-var">Transp</span></a><span> </span><a name="local-1627820593"><a href="#local-1627820593"><span class="hs-identifier">lN</span></a></a><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-glyph">\</span><span class="hs-keyword">case</span><span>
</span><a name="line-104"></a><span>        </span><span class="hs-identifier">_</span><span> </span><span class="hs-operator hs-var">:&lt;</span><span> </span><span class="hs-identifier hs-var">&#216;</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-glyph">\</span><span class="hs-keyword">case</span><span>
</span><a name="line-105"></a><span>          </span><a name="local-1627820594"><a href="#local-1627820594"><span class="hs-identifier">dtdz</span></a></a><span> </span><span class="hs-operator hs-var">:&lt;</span><span> </span><span class="hs-identifier hs-var">&#216;</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">only</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="TensorOps.Types.html#transp"><span class="hs-identifier hs-var">transp</span></a><span> </span><a href="#local-1627820594"><span class="hs-identifier hs-var">dtdz</span></a><span> </span><span class="hs-operator hs-var">\\</span><span> </span><a href="Type.Family.List.Util.html#reverseReverse"><span class="hs-identifier hs-var">reverseReverse</span></a><span> </span><a href="#local-1627820593"><span class="hs-identifier hs-var">lN</span></a><span>
</span><a name="line-106"></a><span>    </span><a href="TensorOps.Types.html#Shuffle"><span class="hs-identifier hs-var">Shuffle</span></a><span> </span><a name="local-1627820595"><a href="#local-1627820595"><span class="hs-identifier">is</span></a></a><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-glyph">\</span><span class="hs-identifier">_</span><span> </span><a name="local-1627820596"><a href="#local-1627820596"><span class="hs-identifier">dtdz</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><a name="line-107"></a><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">ixds</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Prod</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Index</span><span> </span><a href="#local-1627820573"><span class="hs-identifier hs-type">ns</span></a><span> </span><span class="hs-operator">:&amp;:</span><span> </span><a href="#local-1627820575"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627820574"><span class="hs-identifier hs-type">ms</span></a><span>
</span><a name="line-108"></a><span>          </span><a name="local-1627820597"><a href="#local-1627820597"><span class="hs-identifier">ixds</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Data.Type.Product.Util.html#zipProd"><span class="hs-identifier hs-var">zipProd</span></a><span> </span><a href="#local-1627820595"><span class="hs-identifier hs-var">is</span></a><span> </span><a href="#local-1627820596"><span class="hs-identifier hs-var">dtdz</span></a><span>
</span><a name="line-109"></a><span>          </span><span class="hs-identifier">f</span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-1627820599"><a href="#local-1627820599"><span class="hs-identifier">n</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-110"></a><span>             </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Index</span><span> </span><a href="#local-1627820573"><span class="hs-identifier hs-type">ns</span></a><span> </span><a href="#local-1627820599"><span class="hs-identifier hs-type">n</span></a><span>
</span><a name="line-111"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Sing</span><span> </span><a href="#local-1627820599"><span class="hs-identifier hs-type">n</span></a><span>
</span><a name="line-112"></a><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1627820575"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-1627820599"><span class="hs-identifier hs-type">n</span></a><span>
</span><a name="line-113"></a><span>          </span><a name="local-1627820598"><a href="#local-1627820598"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-1627820600"><a href="#local-1627820600"><span class="hs-identifier">i</span></a></a><span> </span><a name="local-1627820601"><a href="#local-1627820601"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldl'</span><span> </span><span class="hs-special">(</span><a href="TensorOps.Tensor.html#zip2"><span class="hs-identifier hs-var">TT</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">zip2</span></a><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">+</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="TensorOps.Tensor.html#konst"><span class="hs-identifier hs-var">TT</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">konst</span></a><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">foldMap1</span><span> </span><a href="#local-1627820602"><span class="hs-identifier hs-var">g</span></a><span> </span><a href="#local-1627820597"><span class="hs-identifier hs-var">ixds</span></a><span class="hs-special">)</span><span>
</span><a name="line-114"></a><span>                    </span><span class="hs-operator hs-var">\\</span><span> </span><a href="#local-1627820601"><span class="hs-identifier hs-var">s</span></a><span>
</span><a name="line-115"></a><span>            </span><span class="hs-keyword">where</span><span>
</span><a name="line-116"></a><span>              </span><span class="hs-identifier">g</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-1627820603"><a href="#local-1627820603"><span class="hs-identifier">m</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-117"></a><span>                </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Index</span><span> </span><a href="#local-1627820573"><span class="hs-identifier hs-type">ns</span></a><span> </span><span class="hs-operator">:&amp;:</span><span> </span><a href="#local-1627820575"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span> </span><a href="#local-1627820603"><span class="hs-identifier hs-type">m</span></a><span>
</span><a name="line-118"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-1627820575"><span class="hs-identifier hs-type">t</span></a><span> </span><a href="#local-1627820599"><span class="hs-identifier hs-type">n</span></a><span class="hs-special">]</span><span>
</span><a name="line-119"></a><span>              </span><a name="local-1627820602"><a href="#local-1627820602"><span class="hs-identifier">g</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1627820604"><a href="#local-1627820604"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-operator hs-var">:&amp;:</span><span> </span><a name="local-1627820605"><a href="#local-1627820605"><span class="hs-identifier">d</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">testEquality</span><span> </span><a href="#local-1627820604"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-1627820600"><span class="hs-identifier hs-var">i</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-120"></a><span>                </span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-identifier hs-var">Refl</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><a href="#local-1627820605"><span class="hs-identifier hs-var">d</span></a><span class="hs-special">]</span><span>
</span><a name="line-121"></a><span>                </span><span class="hs-identifier hs-var">Nothing</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><a name="line-122"></a><span>      </span><span class="hs-keyword">in</span><span>  </span><span class="hs-identifier hs-var">imap1</span><span> </span><a href="#local-1627820598"><span class="hs-identifier hs-var">f</span></a><span> </span><span class="hs-special">(</span><a href="Data.Type.Sing.html#singProd"><span class="hs-identifier hs-var">singProd</span></a><span> </span><a href="#local-1627820576"><span class="hs-identifier hs-var">sNs</span></a><span class="hs-special">)</span><span>
</span><a name="line-123"></a><span>
</span><a name="line-124"></a><span class="hs-identifier">gradTensorOp</span><span>
</span><a name="line-125"></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><a name="local-1627820571"><a href="#local-1627820571"><span class="hs-identifier">ns</span></a></a><span> </span><a name="local-1627820572"><a href="#local-1627820572"><span class="hs-identifier">t</span></a></a><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><a href="TensorOps.Types.html#Tensor"><span class="hs-identifier hs-type">Tensor</span></a><span> </span><a href="#local-1627820572"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Floating</span><span> </span><span class="hs-special">(</span><a href="TensorOps.Types.html#ElemT"><span class="hs-identifier hs-type">ElemT</span></a><span> </span><a href="#local-1627820572"><span class="hs-identifier hs-type">t</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-126"></a><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><a href="TensorOps.Types.html#TensorOp"><span class="hs-identifier hs-type">TensorOp</span></a><span> </span><a href="#local-1627820571"><span class="hs-identifier hs-type">ns</span></a><span> </span><span class="hs-char">'[ '[] ]
    -&gt; Prod t ns    -- ^ inputs
    -&gt; Prod t ns    -- ^ d target / d inputs
gradTensorOp = \case
    OP&#216;            -&gt; \_ -&gt; only $ TT.konst 1
    -- ns ~ a ++ d
    Pop (sA :: Sing a)
        (sB :: Sing b)
        (sD :: Sing d)
        (o  :: TOp a b)
        (os :: OpPipe TOp (b ++ d) '[ '[] ])
                   -&gt; \x -&gt; let lA   :: Length a
                                lA   = singLength sA
                                lB   :: Length b
                                lB   = singLength sB
                                lD   :: Length d
                                lD   = singLength sD
                                y    :: Prod t (b ++ d)
                                y    = overProdInit lA lD
                                                    (runTOp sA sB o)
                                                    x
                                dtdy :: Prod t (b ++ d)
                                dtdy = gradTensorOp os y
                                res  :: Prod t (a ++ d)
                                res  = overProdInit lB lD
                                                    (gradTOp sA sB o (takeProd lA lD x))
                                                    dtdy
                            in  res
</span></pre></body></html>